# Manaully working with microservice

First we need to set things up. Make sure that port forwarding is correct and 
that you are using the correct ports. We also set the headers that we want 
to pass into the micro-service. These should be generated by the gateway. 

    sudo iptables -P FORWARD ACCEPT

    $contextHeaders = @{
        user_id='638d111c-c7bb-4710-8ea2-91c4bc3ea530'
        transaction_id='638d111c-c7bb-4710-8ea2-91c4bc3ea530'
    }

    # port 32080 as set in the yaml for the NodePort
    $domain = "http://localhost:32080"

    $domain = "http://localhost:2083"

Now we want to check basic connectivity. A ping doesn't require authentication. 

    Write-Host $domain
    # Default route
    Invoke-WebRequest `
        -Method GET `
        -Uri "$domain/ping" 

Let's test a basic case which require authentication.

    # Default route
    Invoke-WebRequest `
        -Method GET `
        -Uri $domain `
        -Headers $contextHeaders 
        

    # Default route
    $users = Invoke-RestMethod `
        -Method GET `
        -Uri $domain/users `
        -Headers $contextHeaders 
    $users | measure | %{ if ($_.Count -lt 1) { Write-Error "no users found." } 
        else { 
            Write-Host "usres found"  
            $users | Format-Table
        }
    }

    # Default route
    $user = Invoke-RestMethod `
        -Method GET `
        -Uri $domain/users/one@three.com `
        -Headers $contextHeaders 
    if ($user -eq $null) { Write-Error "no user found." } 
    $user


Let's get down to business, and create some users, groups, and roles. 
First we'll start with some users

    function Create-User {
      param (
        [Parameter(Mandatory=$true)]
        [string]
        $Email,
        [Parameter(Mandatory=$true)]
        [string]
        $First,
        [Parameter(Mandatory=$true)]
        [string]
        $Last
      )
      $user = @{ 
        email=$Email
        first_name=$First
        last_name=$Last
      } | ConvertTo-Json
      $ret = Invoke-RestMethod `
         -Method Post `
         -Body $user `
         -Uri $domain/users `
         -Headers $contextHeaders 
      if ($ret -eq $null) { Write-Error "no user found." } 
      $user
    }

    Create-User `
      -Email 'adam@blyth.com' `
      -First 'adam' `
      -Last 'blyth'

    Create-User `
      -Email 'garry@smith.com' `
      -First 'garry' `
      -Last 'smith'

    Create-User `
      -Email 'hank@blytho.com' `
      -First 'hank' `
      -Last 'blyth'

    Create-User `
      -Email 'iliza@smith.com' `
      -First 'iliza' `
      -Last 'smith'

    # Let's look at who is in the system
    Invoke-RestMethod `
      -Method GET `
      -Uri $domain/users `
      -Headers $contextHeaders 


Now lets do something with groups

    function Create-Group {
      param (
        [Parameter(Mandatory=$true)]
        [string]
        $Name
      )
      $group = @{ 
        name=$Name
      } | ConvertTo-Json
      $group = Invoke-RestMethod `
         -Method Post `
         -Body $group `
         -Uri $domain/groups `
         -Headers $contextHeaders 
      if ($group -eq $null) { Write-Error "no user found." } 
      $group
    }

    $x = Create-Group `
      -Name ChessPlayers

      $ret Invoke-RestMethod `
         -Method Post `
         -Body $group `
         -Uri $domain/groups `
         -Headers $contextHeaders 

    ### Groups
    $groups = Invoke-RestMethod `
      -Method GET `
      -Uri $domain/groups `
      -Headers $contextHeaders 
    $groups
    $groups[0].users


    ### Roles
    $jane = @{ 
        email='iliza@smith.com'
        first_name='iliza'
        last_name='smith'
    } | ConvertTo-Json
    $ret = Invoke-RestMethod `
        -Method Post `
        -Body $jane `
        -Uri $domain/users `
        -Headers $contextHeaders 
    if ($ret -eq $null) { Write-Error "no user found." } 




    ### Groups

    $groups = Invoke-RestMethod `
        -Method GET `
        -Uri $domain/groups `
        -Headers $contextHeaders 
    $groups | measure | %{ if ($_.Count -lt 1) { Write-Error "no groups found." } }


    ### Roles

    $roles = Invoke-RestMethod `
        -Method GET `
        -Uri $domain/roles `
        -Headers $contextHeaders 
    $roles | measure | %{ if ($_.Count -lt 1) { Write-Error "no roles found." } }





    kubectl run `
        -it svclookup `
        --image=tutum/dnsutils `
        --rm `
        --restart=Never -- dig SRV identity-db-statefulset.default.svc.cluster.local








